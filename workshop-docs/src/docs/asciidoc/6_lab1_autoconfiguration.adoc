== Lab 1: Auto Configuration

.In the first step we start quite easy by just adding the spring boot starter dependency for spring security.

We just need to add the following two dependencies to the _build.gradle_ file of the initial application (lab-1/initial-library-server_).

.build.gradle

include::../snippets/step-1-gradle-build.adoc[]

.Authentication using in-memory user

image::images/workshop_lab_3.png[scaledwidth="75%",alt="Library service authentication"]

Please start the application by running the class _InitialLibraryServerApplication_.

=== Login

Spring Security 5 added a nicer auto-generated login form (build with bootstrap library).

.Autogenerated login formular

image::images/loginform.png[scaledwidth="40%", scaledheight="40%",alt="owasp_top_10"]

If you browse to http://localhost:8080/books[localhost:8080/books] then you will notice
that a login form appears in the browser window.

[TIP]
====
But wait - what are the credentials for a user to log in?

With spring security autoconfigured by spring boot the credentials are as follows:

* Username=user
* Password=<Look into the console log!>
====

.console log

include::../snippets/step-1-default-password-console.adoc[]

Of course you won't use the generated password for any serious application as this will change with each restart of the
application.

Instead you can easily just change the password to a static value by changing the _application.yaml_ file.

.application.yml
[source,yaml]
----
spring:
  ...
  security:
    user:
      password: secret
----

[NOTE]
====
Please make sure the indents of the content is correct in yaml formatted files. If this is not the case you can get
really strange errors sometimes.
====

As you can see, if Spring Security is on the classpath,
then the web application is secured by default.
https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-security[Spring boot] auto-configured
basic authentication and form based authentication for all web endpoints.

[NOTE]
====
https://www.owasp.org/index.php/Top_10-2017_A5-Broken_Access_Control[OWASP Top 10-2017 A5-Broken Access Control]

- With the exception of public resources, deny by default
====

.Form-based authentication with session cookies

image::images/session_auth.png[scaledwidth="50%", scaledheight="50%",alt="form_login"]

This also applies to all actuator endpoints like http://localhost:8080/actuator/health[/actuator/health].
All monitoring web endpoints can now only be accessed with an authenticated user.
See https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-security-actuator[Actuator Security]
for details.

=== Common Security Problems

Additionally spring security improved the security of the web application automatically for:

* https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#ns-session-fixation[Session Fixation]:
Session Fixation is an attack that permits an attacker to hijack a valid user session. +
If you want to learn more about this please read the https://www.owasp.org/index.php/Session_fixation[Session Fixation page at OWASP]
* https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#csrf[Cross Site Request Forgery (CSRF)]:
Cross-Site Request Forgery (CSRF) is an attack that forces an end user to execute unwanted actions on a web application in which they're currently authenticated. +
If you want to know what CSRF really is and how to mitigate this attack please consult https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)[CSRF attack description at OWASP]

* https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#default-security-headers[Default Security Headers]:
This automatically adds all recommended security response headers to all http responses. You can find more information about this topic
in the https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#tab=Main[OWASP Secure Headers Project]

.default security response headers

include::../snippets/step-1-security-response-header.adoc[]

=== Logout

Spring security 5 also added a bit more user friendly logout functionality out of the box.
If you direct your browser to http://localhost:8080/logout[localhost:8080/logout] you will see the following
dialog on the screen.

.Autogenerated logout formular

image::images/logoutform.png[scaledwidth="40%", scaledheight="40%",alt="owasp_top_10"]

The application already contains a central error handler for the whole web application using _@RestControllerAdvice_.
You can find this in class _com.example.library.server.api.ErrorHandler_.

To handle potential future access denied error we add the following new block to this class:

.com.example.library.server.api.ErrorHandler
[source,java]
----
import org.springframework.security.access.AccessDeniedException;

@RestControllerAdvice
public class ErrorHandler {

  @ExceptionHandler(AccessDeniedException.class)
  public Mono<ResponseEntity<String>> handle(AccessDeniedException ex) {
    Logger logger = LoggerFactory.getLogger(this.getClass());
    logger.error(ex.getMessage());
    return Mono.just(ResponseEntity.status(HttpStatus.FORBIDDEN).build());
  }
  // ...
}
----

[NOTE]
====
If you try to run the existing tests in package _com.example.library.server.api_ you will
notice that these are not _green_ any more. This is due to the security enforcements
by Spring Security.
====

Now all requests in the tests require an authenticated user and fail with http status 401 (Unauhorized).

All tests using requests with _POST_, _PUT_ or _DELETE_ methods are failing with http status 403 (Forbidden).
These requests are now protected against https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)[CSRF] attacks
and require CSRF tokens.

To achieve authentication in the tests you have to add the annotation _@WithMockUser_ on class level.
CSRF is handled by mutating the requests inside the tests by adding this snippet to the failing tests:

.com.example.library.server.api.BookApiDocumentationTest
[source,java]
----
//...
import static org.springframework.security.test.web.reactive.server.SecurityMockServerConfigurers.csrf;
//...
webTestClient.mutateWith(csrf())
        //...
----


This concludes the first step.

[NOTE]
====
You find the completed code in project **lab-1/complete-library-server**.
====

Now let's proceed to next step and start with customizing the authentication part.
