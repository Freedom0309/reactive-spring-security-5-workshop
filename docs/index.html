<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<meta name="author" content="Andreas Falk">
<title>Reactive Spring Security 5.1 Hands-On Workshop</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Reactive Spring Security 5.1 Hands-On Workshop</h1>
<div class="details">
<span id="author" class="author">Andreas Falk</span><br>
<span id="email" class="email"><a href="mailto:andreas.falk@novatec-gmbh.de">andreas.falk@novatec-gmbh.de</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_requirements_for_this_workshop">1.1. Requirements for this workshop</a></li>
</ul>
</li>
<li><a href="#_common_web_security_risks">2. Common Web Security Risks</a></li>
<li><a href="#_the_workshop_application">3. The workshop application</a>
<ul class="sectlevel2">
<li><a href="#_reactive_systems_streams">3.1. Reactive Systems &amp; Streams</a>
<ul class="sectlevel3">
<li><a href="#_project_reactor">3.1.1. Project Reactor</a></li>
<li><a href="#_spring_webflux">3.1.2. Spring WebFlux</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_workshop_organization">4. Workshop Organization</a></li>
<li><a href="#_workshop_steps">5. Workshop Steps</a>
<ul class="sectlevel2">
<li><a href="#_step_1_auto_configuration">5.1. Step 1: Auto Configuration</a></li>
<li><a href="#_step_2_customize_authentication">5.2. Step 2: Customize Authentication</a></li>
<li><a href="#_step_3_add_authorization">5.3. Step 3: Add Authorization</a></li>
<li><a href="#_step_4_security_testing">5.4. Step 4: Security Testing</a></li>
<li><a href="#_step_5_oauth2_openid_connect">5.5. Step 5: OAuth2/OpenID Connect</a>
<ul class="sectlevel3">
<li><a href="#_introduction_2">5.5.1. Introduction</a></li>
<li><a href="#_oauth2_oidc_in_spring_security_5">5.5.2. OAuth2/OIDC in Spring Security 5</a></li>
<li><a href="#_what_we_will_build">5.5.3. What we will build</a></li>
<li><a href="#identity-server">5.5.4. UAA Identity Server</a></li>
<li><a href="#resource-server">5.5.5. Resource Server (Library-Server)</a></li>
<li><a href="#oauth2-login-client">5.5.6. OAuth2 Login Client</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_feedback">6. Feedback</a></li>
<li><a href="#_online_references">Appendix A: Online References</a></li>
<li><a href="#_book_references">Appendix B: Book References</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/entwicklertag_frankfurt.jpg" alt="novatec">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a><a class="link" href="#_introduction">1. Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Target of this workshop is to learn how to make an initially unsecured (reactive) web application
more and more secure step-by-step.</p>
</div>
<div class="paragraph">
<p>This will be done in following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add spring boot security starter dependency for simple auto configuration of security</p>
</li>
<li>
<p>Customize authentication configuration (provide our own user store)</p>
</li>
<li>
<p>Add authorization (access controls) to web and method layers</p>
</li>
<li>
<p>Implement automated security integration tests</p>
</li>
<li>
<p>Experiment with new OAuth2 Login Client and Resource Server of Spring Security 5.1</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_requirements_for_this_workshop"><a class="anchor" href="#_requirements_for_this_workshop"></a><a class="link" href="#_requirements_for_this_workshop">1.1. Requirements for this workshop</a></h3>
<div class="ulist">
<ul>
<li>
<p>Git</p>
</li>
<li>
<p>A Java JDK (Java 8 or 11 are supported and tested)</p>
</li>
<li>
<p>Any Java IDE capable of building with Gradle (IntelliJ, Eclipse, VS Code, &#8230;&#8203;)</p>
</li>
<li>
<p>Basic knowledge of <a href="https://www.reactivemanifesto.org">Reactive Systems</a> and reactive programming using <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#spring-webflux">Spring WebFlux</a> &amp; <a href="https://projectreactor.io">Reactor</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As we are building the samples using <a href="https://gradle.org">Gradle</a> your Java IDE should be capable use this.
As IntelliJ user support for Gradle is included by default.
As an Eclipse user you have to install a plugin via the marketplace</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/eclipse_gradle.png" alt="eclipse_gradle">
</div>
</div>
<div class="paragraph">
<p>To get the workshop project you either can just clone the repository using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>https://github.com/andifalk/reactive-spring-security-5-workshop.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code> git@github.com:andifalk/reactive-spring-security-5-workshop.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>or simply download it as a <a href="https://github.com/andifalk/reactive-spring-security-5-workshop/archive/master.zip">zip archive</a>.</p>
</div>
<div class="paragraph">
<p>After that you can import the workshop project into your IDE</p>
</div>
<div class="ulist">
<ul>
<li>
<p>IntelliJ: "New project from existing sources&#8230;&#8203;"</p>
</li>
<li>
<p>Eclipse: "Import/Gradle/Existing gradle project"</p>
</li>
<li>
<p>Visual Studio Code: Just open the corresponding project directory</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_common_web_security_risks"><a class="anchor" href="#_common_web_security_risks"></a><a class="link" href="#_common_web_security_risks">2. Common Web Security Risks</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this workshop you will strive various parts of securing a web application that
fit into the <a href="https://www.owasp.org/index.php/Top_10-2017_Top_10">OWASP Top 10 2017 list</a>.</p>
</div>
<div class="paragraph">
<p>We will look at:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A2: Broken Authentication</p>
</li>
<li>
<p>A3: Sensitive Data Exposure</p>
</li>
<li>
<p>A5: Broken Access Control</p>
</li>
<li>
<p>A6: Security Misconfiguration</p>
</li>
<li>
<p>A10: Insufficient Logging &amp; Monitoring</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/owasp_top_10_2017.png" alt="owasp_top_10">
</div>
</div>
<div class="paragraph">
<p>You may also have a look into the <a href="https://www.owasp.org/index.php/OWASP_Proactive_Controls">OWASP ProActive Controls</a> document which describes how to develop
your applications using good security patterns.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You will find more sources of information about security referenced in the appendix section.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_workshop_application"><a class="anchor" href="#_the_workshop_application"></a><a class="link" href="#_the_workshop_application">3. The workshop application</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this workshop you will be provided a finished but completely unsecured reactive
web application. This library server application provides a RESTful service for administering books and users.</p>
</div>
<div class="paragraph">
<p>The RESTful service for books is build using the Spring WebFlux annotation model and the RESTful service for
users is build using the Spring WebFlux router model.</p>
</div>
<div class="paragraph">
<p>The application contains a complete documentation for the RESTful API build with spring rest docs
which you can find in the directory <em>build/asciidoc/html5</em>
after performing a full gradle build.</p>
</div>
<div class="paragraph">
<p>The domain model of this application is quite simple and just consists of <em>Book</em> and <em>User</em>.
The packages of the application are organized as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>api</strong>: Contains the complete RESTful service</p>
</li>
<li>
<p><strong>business</strong>: All the service classes (quite simple for workshop, usually containing business logic)</p>
</li>
<li>
<p><strong>dataaccess</strong>: All domain models and repositories</p>
</li>
<li>
<p><strong>config</strong>: All spring configuration classes</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For users of IntelliJ you find http scripts to test all the RESTful services in sub directory <em>http</em>
of all projects.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are three target user roles for this application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Standard users</strong>: A standard user can borrow and return his currently borrowed books</p>
</li>
<li>
<p><strong>Curators</strong>: A curator user can add or delete books</p>
</li>
<li>
<p><strong>Administrators</strong>: An administrator user can add or remove users</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The application is build using</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring 5 WebFlux on Netty</p>
</li>
<li>
<p>Spring Data MongoDB with reactive driver</p>
</li>
<li>
<p>In-memory Mongodb to have an easier setup for the workshop</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following subsections give a very condensed introduction to the basics of Reactive Systems,
the Project Reactor and Spring WebFlux.<br>
This might help to better understand the sample application for beginners of Reactive.</p>
</div>
<div class="sect2">
<h3 id="_reactive_systems_streams"><a class="anchor" href="#_reactive_systems_streams"></a><a class="link" href="#_reactive_systems_streams">3.1. Reactive Systems &amp; Streams</a></h3>
<div class="quoteblock">
<blockquote>
Reactive Systems are Responsive, Resilient, Elastic and Message Driven (Asynchronous).
</blockquote>
<div class="attribution">
&#8212; https://www.reactivemanifesto.org
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Responsiveness</strong> means the system responds in a timely manner and is the cornerstone of usability</p>
</li>
<li>
<p><strong>Resilience</strong> means the system stays responsive in the face of failure</p>
</li>
<li>
<p><strong>Elasticity</strong> means that the throughput of a system scales up or down automatically to
meet varying demand as resource is proportionally added or removed</p>
</li>
<li>
<p><strong>Message Driven</strong> systems rely on asynchronous message-passing to establish a boundary between components
that ensures loose coupling</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
Reactive Streams is an initiative to provide a standard for asynchronous stream processing with non-blocking back pressure..
</blockquote>
<div class="attribution">
&#8212; http://www.reactive-streams.org/
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Back-Pressure</strong>: When one component is struggling to keep-up, the system as a whole needs to respond in a sensible way.
Back-pressure is an important feedback mechanism that allows systems to gracefully respond to load rather than
collapse under it.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_project_reactor"><a class="anchor" href="#_project_reactor"></a><a class="link" href="#_project_reactor">3.1.1. Project Reactor</a></h4>
<div class="paragraph">
<p>The project <a href="https://projectreactor.io">Reactor</a> is a Reactive library for building non-blocking applications on
the JVM based on the <a href="http://www.reactive-streams.org">Reactive Streams Specification</a> and can help to build
Reactive Systems.</p>
</div>
<div class="paragraph">
<p>Reactor is a fully non-blocking foundation and offers backpressure-ready
network engines for HTTP (including Websockets), TCP and UDP.</p>
</div>
<div class="paragraph">
<p>Reactor introduces composable reactive types that implement Publisher but also provide a rich vocabulary of operators,
most notably <em>Flux</em> and <em>Mono</em>.</p>
</div>
<div class="paragraph">
<p>A <em>Mono&lt;T&gt;</em> is a specialized <em>Publisher&lt;T&gt;</em> that emits at most one item and then optionally terminates with
an onComplete signal or an onError signal.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/mono.png" alt="reactor_mono">
</div>
<div class="title">Figure 1. Mono, an Asynchronous 0-1 Result (source: projectreactor.io)</div>
</div>
<div class="paragraph">
<p>A <em>Flux&lt;T&gt;</em> is a standard <em>Publisher&lt;T&gt;</em> representing an asynchronous sequence of 0 to N emitted items,
optionally terminated by either a completion signal or an error.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/flux.png" alt="reactor_flux">
</div>
<div class="title">Figure 2. Flux, an Asynchronous Sequence of 0-N Items (source: projectreactor.io)</div>
</div>
</div>
<div class="sect3">
<h4 id="_spring_webflux"><a class="anchor" href="#_spring_webflux"></a><a class="link" href="#_spring_webflux">3.1.2. Spring WebFlux</a></h4>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#spring-webflux">Spring WebFlux</a>
was added in Spring Framework 5.0. It is fully non-blocking, supports Reactive Streams back pressure, and runs
on servers such as Netty, Undertow, and Servlet 3.1+ containers.</p>
</div>
<div class="paragraph">
<p>Spring Webflux depends on Reactor and uses it internally to compose asynchronous logic
and to provide Reactive Streams support.<br>
It provides two programming models:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Annotated Controllers: This is uses the same annotations as in the Spring MVC part</p>
</li>
<li>
<p>Functional Endpoints:  This provides a lambda-based, lightweight, functional programming model</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_workshop_organization"><a class="anchor" href="#_workshop_organization"></a><a class="link" href="#_workshop_organization">4. Workshop Organization</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This interactive hands-on workshop is organized into several step with one step building upon each other.
There is a separate project for each step:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>reactive-playground</strong>: This project provides a playground to try reactive streams with project reactor</p>
</li>
<li>
<p><strong>00-library-server</strong>: This contains the initial unsecured application</p>
</li>
<li>
<p><strong>01-library-server</strong>: This has just added the spring boot starter dependencies for spring security</p>
</li>
<li>
<p><strong>02-library-server</strong>: This adds a persistent user store for authentication</p>
</li>
<li>
<p><strong>03-library-server</strong>: This adds custom authentication and authorization rules</p>
</li>
<li>
<p><strong>04-library-server</strong>: This adds automatic integration tests for authorization</p>
</li>
<li>
<p><strong>05-oauth2</strong>: This adds an OAuth2 login client and resource server for interacting with an identity server for login</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_workshop_steps"><a class="anchor" href="#_workshop_steps"></a><a class="link" href="#_workshop_steps">5. Workshop Steps</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To start the workshop please begin by adapting the <em>00-library-server</em> application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are not able to keep up with completing a particular step you
always can just start over with the existing application of next step.</p>
</div>
<div class="paragraph">
<p>For example if you could not manage to complete the tutorial based on <em>01-library-server</em>
just continue using <em>02-library-server</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_step_1_auto_configuration"><a class="anchor" href="#_step_1_auto_configuration"></a><a class="link" href="#_step_1_auto_configuration">5.1. Step 1: Auto Configuration</a></h3>
<div class="paragraph">
<div class="title">In the first step we start quite easy by just adding the spring boot starter dependency for spring security.</div>
<p>We just need to add the following two dependencies to the <em>build.gradle</em> file of the initial application (<em>00-library-server</em>).</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-groovy" data-lang="groovy">dependencies {
    ...
    compile('org.springframework.boot:spring-boot-starter-security') <i class="conum" data-value="1"></i><b>(1)</b>
    ...
    testCompile('org.springframework.security:spring-security-test') <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The spring boot starter for spring security</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Adds testing support for spring security</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please start the application by running the class <em>LibraryServerApplication</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/loginform.png" alt="owasp_top_10">
</div>
</div>
<div class="paragraph">
<p>If you browse to <a href="http://localhost:8080/books">localhost:8080/books</a> then you will notice
that a login form appears in the browser window.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>But wait - what are the credentials for a user to log in?</p>
</div>
<div class="paragraph">
<p>With spring security autoconfigured by spring boot the credentials are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username=user</p>
</li>
<li>
<p>Password=&lt;Look into the console log!&gt;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">console log</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>INFO 18465 --- [  restartedMain] ctiveUserDetailsServiceAutoConfiguration :

Using default security password: ded10c78-0b2f-4ae8-89fe-c267f9a29e1d</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, if Spring Security is on the classpath,
then the web application is secured by default.
<a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-security">Spring boot</a> auto-configured
basic authentication and form based authentication for all web endpoints.</p>
</div>
<div class="paragraph">
<p>This also applies to all actuator endpoints like <a href="http://localhost:8080/actuator/health">/actuator/health</a>.
All monitoring web endpoints can now only be accessed with an authenticated user.
See <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-security-actuator">Actuator Security</a>
for details.</p>
</div>
<div class="paragraph">
<p>Additionally spring security improved the security of the web application automatically for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#ns-session-fixation">Session Fixation</a>:
Session Fixation is an attack that permits an attacker to hijack a valid user session.<br>
If you want to learn more about this please read the <a href="https://www.owasp.org/index.php/Session_fixation">Session Fixation page at OWASP</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#csrf">Cross Site Request Forgery (CSRF)</a>:
Cross-Site Request Forgery (CSRF) is an attack that forces an end user to execute unwanted actions on a web application in which they&#8217;re currently authenticated.<br>
If you want to know what CSRF really is and how to mitigate this attack please consult <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)">CSRF attack description at OWASP</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#default-security-headers">Default Security Headers</a>:
This automatically adds all recommended security response headers to all http responses. You can find more information about this topic
   in the <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#tab=Main">OWASP Secure Headers Project</a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">default security response headers</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Expires: 0
Pragma: no-cache
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1 ; mode=block</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring security 5 also added a bit more user friendly logout functionality out of the box.
If you direct your browser to <a href="http://localhost:8080/logout">localhost:8080/logout</a> you will see the following
dialog on the screen.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/logoutform.png" alt="owasp_top_10">
</div>
</div>
<div class="paragraph">
<p>This concludes the first step.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You find the completed code in project <em>01-library-server</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s proceed to next step and start with customizing the authentication part.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_customize_authentication"><a class="anchor" href="#_step_2_customize_authentication"></a><a class="link" href="#_step_2_customize_authentication">5.2. Step 2: Customize Authentication</a></h3>
<div class="paragraph">
<div class="title">Now it is time to start customizing the auto-configuration.</div>
<p>The spring boot auto-configuration will back-off a bit in this step and will back-off completely in next step.</p>
</div>
<div class="paragraph">
<p>We start by replacing the default user/password with our own persistent user storage (already present in MongoDB).
To do this we add a new class <em>WebSecurityConfiguration</em> to package <em>com.example.library.server.config</em> having the following
contents.</p>
</div>
<div class="listingblock">
<div class="title">WebSecurityConfiguration class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.library.server.config;

import org.springframework.context.annotation.Bean;
import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;

@EnableWebFluxSecurity <i class="conum" data-value="1"></i><b>(1)</b>
public class WebSecurityConfiguration {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder(); <i class="conum" data-value="2"></i><b>(2)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This auto-configures the SecurityWebFilterChain</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This adds the new delegating password encoder introduced in spring security 5</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <em>WebSecurityConfiguration</em> implementation does two important things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>This adds the <em>SecurityWebFilterChain</em>. If you already have secured servlet based spring mvc web applications
then you might know what&#8217;s called the
<a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#security-filter-chain"><em>spring security filter chain</em></a>.
In spring webflux the <em>SecurityWebFilterChain</em> is the similar approach
based on matching a request with one or more WebFilter.</p>
</li>
<li>
<p>Configures a <em>PasswordEncoder</em>. A password encoder is used by spring security to encrypt passwords and to check
if a given password matches the encrypted one.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">PasswordEncoder interface</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package org.springframework.security.crypto.password;

public interface PasswordEncoder {

	String encode(CharSequence rawPassword); <i class="conum" data-value="1"></i><b>(1)</b>

	boolean matches(CharSequence rawPassword, String encodedPassword); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Encrypts the given cleartext password</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Validates the given cleartext password with the encrypted one (without revealing the unencrypted one)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In spring security 5 creating an instance of the <em>DelegatingPasswordEncoder</em> is much easier by using the class <em>PasswordEncoderFactories</em>.</p>
</div>
<div class="listingblock">
<div class="title">DelegatingPasswordEncoder class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package org.springframework.security.crypto.factory;

public class PasswordEncoderFactories {
    ...
	public static PasswordEncoder createDelegatingPasswordEncoder() {
		String encodingId = "bcrypt"; <i class="conum" data-value="1"></i><b>(1)</b>
		Map&lt;String, PasswordEncoder&gt; encoders = new HashMap&lt;&gt;();
		encoders.put(encodingId, new BCryptPasswordEncoder()); <i class="conum" data-value="2"></i><b>(2)</b>
		encoders.put("ldap", new LdapShaPasswordEncoder());
		encoders.put("MD4", new Md4PasswordEncoder());
		encoders.put("MD5", new MessageDigestPasswordEncoder("MD5"));
		encoders.put("noop", NoOpPasswordEncoder.getInstance());
		encoders.put("pbkdf2", new Pbkdf2PasswordEncoder());
		encoders.put("scrypt", new SCryptPasswordEncoder());
		encoders.put("SHA-1", new MessageDigestPasswordEncoder("SHA-1"));
		encoders.put("SHA-256", new MessageDigestPasswordEncoder("SHA-256"));
		encoders.put("sha256", new StandardPasswordEncoder());

		return new DelegatingPasswordEncoder(encodingId, encoders);
	}
    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>BCrypt is the default for encrypting passwords</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Suitable encoders for decrypting are selected based on prefix in encrypted value</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To have encrypted passwords in our MongoDB store we need to tweak our existing <em>DataInitializer</em> a bit with the
<em>PasswordEncoder</em> we just have configured.</p>
</div>
<div class="listingblock">
<div class="title">DataInitializer class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.library.server;
...
import org.springframework.security.crypto.password.PasswordEncoder;
...

@Component
public class DataInitializer implements CommandLineRunner {

    ...
    private final PasswordEncoder passwordEncoder; <i class="conum" data-value="1"></i><b>(1)</b>

    @Autowired
    public DataInitializer(BookRepository bookRepository, UserRepository userRepository,
                            IdGenerator idGenerator, PasswordEncoder passwordEncoder) {
        ...
        this.passwordEncoder = passwordEncoder;
    }

    ...

    private void createUsers() {
        ...
        userRepository
                .save(
                        new User(
                                USER_IDENTIFIER,
                                "user@example.com",
                                passwordEncoder.encode("user"), <i class="conum" data-value="2"></i><b>(2)</b>
                                "Library",
                                "User",
                                Collections.singletonList(Role.USER)))
                .subscribe();
        ...
    }
    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inject <em>PasswordEncoder</em> to encrypt user passwords</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Change cleartext passwords into encrypted ones (using BCrypt as default)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we already have configured the encrypting part for passwords of our user storage
we need to connect our own user store (the users already stored in the MongoDB) with spring security&#8217;s
authentication manager.</p>
</div>
<div class="paragraph">
<p>This is done in two steps:</p>
</div>
<div class="paragraph">
<p>In the first step we need to implement spring security&#8217;s definition of a user called <em>UserDetails</em>.</p>
</div>
<div class="listingblock">
<div class="title">LibraryUser class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.library.server.security;

import com.example.library.server.business.UserResource;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.AuthorityUtils;
import org.springframework.security.core.userdetails.UserDetails;

import java.util.Collection;
import java.util.stream.Collectors;

public class LibraryUser implements UserDetails { <i class="conum" data-value="1"></i><b>(1)</b>

    private final UserResource userResource; <i class="conum" data-value="2"></i><b>(2)</b>

    public LibraryUser(UserResource userResource) {
        this.userResource = userResource;
    }

    @Override
    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {
        return AuthorityUtils
                .commaSeparatedStringToAuthorityList(
                        userResource.getRoles().stream()
                                .map(rn -&gt; "ROLE_" + rn.name())
                                .collect(Collectors.joining(",")));
    }

    @Override
    public String getPassword() {
        return userResource.getPassword();
    }

    @Override
    public String getUsername() {
        return userResource.getEmail();
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }

    public UserResource getUserResource() {
        return userResource;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To provide our own user store we have to implement the spring security&#8217;s predefined interface <em>UserDetails</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The implementation for <em>UserDetails</em> is backed up by our existing <em>UserResource</em> value object</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the second step we need to implement spring security&#8217;s interface <em>ReactiveUserDetailsService</em> to integrate our user store with the authentication manager.</p>
</div>
<div class="listingblock">
<div class="title">LibraryReactiveUserDetailsService class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.library.server.security;

import com.example.library.server.business.UserService;
import org.springframework.security.core.userdetails.ReactiveUserDetailsService;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

@Service
public class LibraryReactiveUserDetailsService implements ReactiveUserDetailsService { <i class="conum" data-value="1"></i><b>(1)</b>

    private final UserService userService; <i class="conum" data-value="2"></i><b>(2)</b>

    public LibraryReactiveUserDetailsService(UserService userService) {
        this.userService = userService;
    }

    @Override
    public Mono&lt;UserDetails&gt; findByUsername(String username) { <i class="conum" data-value="3"></i><b>(3)</b>
        return userService.findOneByEmail(username).map(LibraryUser::new);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To provide our own user store we have to implement the spring security&#8217;s predefined interface <em>ReactiveUserDetailsService</em>
which is the binding component between the authentication service and our <em>LibraryUser</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>To search and load the targeted user for authentication we use our existing <em>UserService</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This will be called when authentication happens to get user details for validating the password and
adding this user to the security context</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After completing this part of the workshop we now still have the auto-configured <em>SecurityWebFilterChain</em> but we have
replaced the default user with our own users from our MongoDB persistent storage.</p>
</div>
<div class="paragraph">
<p>If you restart the application now you have to use the following user credentials to log in:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. User credentials</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Roles</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:user@example.com">user@example.com</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USER</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:curator@example.com">curator@example.com</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">curator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USER, CURATOR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:admin@example.com">admin@example.com</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">admin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USER, CURATOR, ADMIN</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This is the end of step 2 of the workshop.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You find the completed code in project <em>02-library-server</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the next workshop part we also adapt the <em>SecurityWebFilterChain</em> to our needs and add authorization rules (in web and method layer)
for our application.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_add_authorization"><a class="anchor" href="#_step_3_add_authorization"></a><a class="link" href="#_step_3_add_authorization">5.3. Step 3: Add Authorization</a></h3>
<div class="paragraph">
<div class="title">In this part of the workshop we want to add our customized authorization rules for our application.</div>
<p>As a result of the previous workshop steps we now have authentication for all our web endpoints
(including the actuator endpoints) and we can log in using our own users. But here security does not stop.</p>
</div>
<div class="paragraph">
<p>We know who is using our application (<strong>authentication</strong>) but we do not have control over what this user is
allowed to do in our application (<strong>authorization</strong>).</p>
</div>
<div class="paragraph">
<p>As a best practice the authorization should always be implemented on different layers like the web and method layer.
This way the authorization still prohibits access even if a user manages to bypass the web url based authorization filter
by playing around with manipulated URL&#8217;s.</p>
</div>
<div class="paragraph">
<p>Our required authorization rule matrix looks like this:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Authorization rules for library-server</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Http method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Restricted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Roles with access</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/<strong>.css,/</strong>.jpg,/*.ico,&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/books</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CURATOR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/books</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CURATOR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/users</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADMIN</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/actuator/health</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/actuator/info</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/actuator/*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADMIN</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All authenticated ones</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All the web layer authorization rules are configured in the <em>WebSecurityConfiguration</em> class by adding
a new bean for <em>SecurityWebFilterChain</em>. Here we also already switch on the support for method layer authorization
by adding the annotation <em>@EnableReactiveMethodSecurity</em>.</p>
</div>
<div class="listingblock">
<div class="title">WebSecurityConfiguration class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.library.server.config;

...

@EnableWebFluxSecurity
@EnableReactiveMethodSecurity <i class="conum" data-value="1"></i><b>(1)</b>
public class WebSecurityConfiguration {

    @Bean <i class="conum" data-value="2"></i><b>(2)</b>
    public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
        return http
                .authorizeExchange()
                .matchers(PathRequest.toStaticResources().atCommonLocations()).permitAll() <i class="conum" data-value="3"></i><b>(3)</b>
                .matchers(EndpointRequest.to("health")).permitAll() <i class="conum" data-value="4"></i><b>(4)</b>
                .matchers(EndpointRequest.to("info")).permitAll()
                .matchers(EndpointRequest.toAnyEndpoint()).hasRole(Role.ADMIN.name()) <i class="conum" data-value="5"></i><b>(5)</b>
                .pathMatchers(HttpMethod.POST, "/books").hasRole(Role.CURATOR.name()) <i class="conum" data-value="6"></i><b>(6)</b>
                .pathMatchers(HttpMethod.DELETE, "/books").hasRole(Role.CURATOR.name())
                .pathMatchers("/users/**").hasRole(Role.ADMIN.name()) <i class="conum" data-value="7"></i><b>(7)</b>
                .anyExchange().authenticated() <i class="conum" data-value="8"></i><b>(8)</b>
                .and()
                .httpBasic().and().formLogin().and() <i class="conum" data-value="9"></i><b>(9)</b>
                .logout().logoutSuccessHandler(logoutSuccessHandler()) <i class="conum" data-value="10"></i><b>(10)</b>
                .and()
                .build();
    }

    @Bean <i class="conum" data-value="11"></i><b>(11)</b>
    public ServerLogoutSuccessHandler logoutSuccessHandler() {
        RedirectServerLogoutSuccessHandler logoutSuccessHandler = new RedirectServerLogoutSuccessHandler();
        logoutSuccessHandler.setLogoutSuccessUrl(URI.create("/books"));
        return logoutSuccessHandler;
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This adds support for method level authorization</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configures authentication and web layer authorization for all URL&#8217;s of our REST api</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>All static resources (favicon.ico, css, images, &#8230;&#8203;) can be accessed without authentication</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Actuator endpoints for <em>health</em> and <em>info</em> can be accessed without authentication</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>All other actuator endpoints require authentication</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Modifying access to books require authenticated user having the 'CURATOR' role</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Access to users require authenticated user having the 'ADMIN' role</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>All other web endpoints require authentication</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Authentication can be performed using basic authentication or form based login</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>After logging out it redirects to URL configured in the logout success handler</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>The configured login success handler redirects to <a href="https://localhost:8080/books">/books</a> resource</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We also add a a <em>ServerLogoutSuccessHandler</em> bean to redirect back to the <em>/books</em> endpoint after a logout
to omit the error message we got so far by redirecting to a non-existing page.</p>
</div>
<div class="paragraph">
<p>We continue with authorization on the method layer by adding the rules to our business service classes
<em>BookService</em> and <em>UserService</em>. To achieve this we use the <em>@PreAuthorize</em> annotations provided by spring security.
Same as other spring annotations (e.g. @Transactional) you can put <em>@PreAuthorize</em> annotations on global class level
or on method level.</p>
</div>
<div class="paragraph">
<p>Depending on your authorization model you may use <em>@PreAuthorize</em> to authorize using static roles or
to authorize using dynamic expressions (usually if you have roles with permissions).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/roles_permissions.png" alt="roles_permissions">
</div>
<div class="title">Figure 3. Roles and Permissions</div>
</div>
<div class="paragraph">
<p>If you want to have a permission based authorization you can use the predefined interface <em>PermissionEvaluator</em> inside the
<em>@PreAuthorize</em> annotations like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>class MyService {
    @PreAuthorize("hasPermission(#uuid, 'user', 'write')")
    void myOperation(UUID uuid) {...}
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">PermissionEvaluator class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package org.springframework.security.access;

...
public interface PermissionEvaluator extends AopInfrastructureBean {

	boolean hasPermission(Authentication authentication, Object targetDomainObject,
			Object permission);

	boolean hasPermission(Authentication authentication, Serializable targetId,
			String targetType, Object permission);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the workshop due to time constraints we have to keep things simple so we just use static roles.<br>
Here it is done for the all operations of the book service.</p>
</div>
<div class="listingblock">
<div class="title">BookService class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.library.server.business;

...
import org.springframework.security.access.prepost.PreAuthorize;
...

@Service
@PreAuthorize("hasAnyRole('USER', 'CURATOR', 'ADMIN')") <i class="conum" data-value="1"></i><b>(1)</b>
public class BookService {

    ...

    @PreAuthorize("hasRole('CURATOR')") <i class="conum" data-value="2"></i><b>(2)</b>
    public Mono&lt;Void&gt; create(Mono&lt;BookResource&gt; bookResource) {
        return bookRepository.insert(bookResource.map(this::convert)).then();
    }

    ...

    @PreAuthorize("hasRole('CURATOR')") <i class="conum" data-value="3"></i><b>(3)</b>
    public Mono&lt;Void&gt; deleteById(UUID uuid) {
        return bookRepository.deleteById(uuid).then();
    }
    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In general all users (having either of these 3 roles) can access RESTful services for books</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Only users having role 'CURATOR' can access this RESTful service to create books</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Only users having role 'CURATOR' can access this RESTful service to delete books</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And now we add it the same way for the all operations of the user service.</p>
</div>
<div class="listingblock">
<div class="title">UserService class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.library.server.business;
...
import org.springframework.security.access.prepost.PreAuthorize;
...
@Service
@PreAuthorize("hasRole('ADMIN')") <i class="conum" data-value="1"></i><b>(1)</b>
public class UserService {

    ...

    @PreAuthorize("isAnonymous() or isAuthenticated()") <i class="conum" data-value="2"></i><b>(2)</b>
    public Mono&lt;UserResource&gt; findOneByEmail(String email) {
        return userRepository.findOneByEmail(email).map(this::convert);
    }

    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In general only users having role 'ADMIN' can access RESTful services for users</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>As this operation is used by the <em>LibraryUserDetailsService</em> to perform authentication this
has to be accessible for anonymous users (unless authentication is finished successfully anonymous
users are unauthenticated users)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we have the current user context available in our application we can use this to automatically
set this user as the one who has borrowed a book or returns his borrowed book. The current user can always be evaluated
using the <em>ReactiveSecurityContextHolder</em> class. But a more elegant way is to just let the framework put the current user
directly into our operation via <em>@AuthenticationPrincipal</em> annotation.</p>
</div>
<div class="listingblock">
<div class="title">BookRestController class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.library.server.api;

import org.springframework.security.core.annotation.AuthenticationPrincipal;

@RestController
public class BookRestController {

    ...

    @PostMapping("/books/" + PATH_BOOK_ID + "/borrow")
    public Mono&lt;Void&gt; borrowBookById(
            @PathVariable(PATH_VARIABLE_BOOK_ID) UUID bookId, @AuthenticationPrincipal LibraryUser user) { <i class="conum" data-value="1"></i><b>(1)</b>
        return bookService.borrowById(bookId, user.getUserResource().getId());
    }

    @PostMapping("/books/" + PATH_BOOK_ID + "/return")
    public Mono&lt;Void&gt; returnBookById(@PathVariable(
            PATH_VARIABLE_BOOK_ID) UUID bookId, @AuthenticationPrincipal LibraryUser user) { <i class="conum" data-value="2"></i><b>(2)</b>
        return bookService.returnById(bookId, user.getUserResource().getId());
    }

    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Now that we have an authenticated user context we can add the current user as the one to borrow a book</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Now that we have an authenticated user context we can add the current user as the one to return his borrowed a book</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So please go ahead and re-start the application and try to borrow a book with an authenticated user.
If you are an IntelliJ user you can use the provided <em>book.http</em> file in subdirectory <em>http</em>.</p>
</div>
<div class="paragraph">
<p>At first you will notice that even with the correct basic authentication header you get an error message like this one:</p>
</div>
<div class="listingblock">
<div class="title">CSRF error output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>POST http://localhost:8080/books

HTTP/1.1 403 Forbidden
transfer-encoding: chunked
Content-Type: text/plain
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1 ; mode=block

CSRF Token has been associated to this client

Response code: 403 (Forbidden)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The library-server expects a CSRF token in the request but did not find one. If you use common UI frameworks like
Thymeleaf or JSF (on the serverside) or a clientside one like Angular then these already handle this CSRF processing.</p>
</div>
<div class="paragraph">
<p>In our case we do not have such handler. To successfully tra the borrow book request you have to switch off
CSRF in the library server.<br>
This is done like this in the <em>WebSecurityConfiguration</em> class.</p>
</div>
<div class="listingblock">
<div class="title">Disable CSRF</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>...
@Bean
public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
    return http
        .csrf().disable() <i class="conum" data-value="1"></i><b>(1)</b>
        .authorizeExchange()
        .matchers(PathRequest.toStaticResources().atCommonLocations()).permitAll()
    ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add this line to disable CSRF.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart the application and retry to borrow a book. This time the request should be successful.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not disable CSRF on productive servers if you use session cookies, otherwise you are vulnerable to CSRF attacks.
You may safely disable CSRF for servers that use a stateless authentication approach with bearer tokens like
for OAuth2 or OpenID Connect.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this workshop step we added the authorization to web and method layers. So now for particular RESTful endpoints access is only
permitted to users with special roles.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You find the completed code in project <em>03-library-server</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But how do you know that you have implemented all the authorization rules and did not leave a big security leak
for your RESTful API? Or you may change some authorizations later by accident?</p>
</div>
<div class="paragraph">
<p>To be on a safer side here you need automatic testing. Yes, this can also be done for security!
We will see how this works in the next workshop part.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_security_testing"><a class="anchor" href="#_step_4_security_testing"></a><a class="link" href="#_step_4_security_testing">5.4. Step 4: Security Testing</a></h3>
<div class="paragraph">
<div class="title">Now it is time to prove that we have implemented these authorization rules correctly with automatic testing.</div>
<p>We start testing the rules on method layer for all operations regarding books.</p>
</div>
<div class="paragraph">
<p>The tests will be implemented using the new JUnit 5 version as Spring 5.0 now supports this as well.<br>
In <em>BookServiceTest</em> class we also use the new convenience annotation <em>@SpringJUnitConfig</em> which is a shortcut of
<em>@ExtendWith(value=SpringExtension.class)</em> and <em>@ContextConfiguration</em>.</p>
</div>
<div class="paragraph">
<p>As you can see in the following code only a small part is shown as a sample here to test the <em>BookService.create()</em> operation.
Authorization should always be tested for positive <strong>AND</strong> negative test cases. Otherwise you probably miss an authorization
constraint. Depending on the time left in the workshop you can add some more test cases as you like or just look into the
completed application <em>04-library-server</em>.</p>
</div>
<div class="listingblock">
<div class="title">BookServiceTest class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.library.server.business;

...

@DisplayName("Verify that book service")
@SpringJUnitConfig(LibraryServerApplication.class) <i class="conum" data-value="1"></i><b>(1)</b>
class BookServiceTest {

  @Autowired
  private BookService bookService;

  @MockBean <i class="conum" data-value="2"></i><b>(2)</b>
  private BookRepository bookRepository;

  @MockBean
  private UserRepository userRepository;

  @MockBean
  private IdGenerator idGenerator;

  @DisplayName("grants access to create a book for role 'CURATOR'")
  @Test
  @WithMockUser(roles = "CURATOR")
  void verifyCreateAccessIsGrantedForCurator() { <i class="conum" data-value="3"></i><b>(3)</b>
    when(bookRepository.insert(Mockito.&lt;Mono&lt;Book&gt;&gt;any())).thenReturn(Flux.just(new Book()));
    StepVerifier.create(bookService.create(Mono.just(new BookResource(UUID.randomUUID(),
                    "123456789", "title", "description", Collections.singletonList("author"),
                    false, null)
            ))).verifyComplete();
  }

  @DisplayName("denies access to create a book for roles 'USER' and 'ADMIN'")
  @Test
  @WithMockUser(roles = {"USER", "ADMIN"})
  void verifyCreateAccessIsDeniedForUserAndAdmin() { <i class="conum" data-value="4"></i><b>(4)</b>
    StepVerifier.create(bookService.create(Mono.just(new BookResource(UUID.randomUUID(),
            "123456789", "title", "description", Collections.singletonList("author"),
            false, null)
    ))).verifyError(AccessDeniedException.class);
  }

  @DisplayName("denies access to create a book for anonymous user")
  @Test
  void verifyCreateAccessIsDeniedForUnauthenticated() { <i class="conum" data-value="5"></i><b>(5)</b>
    StepVerifier.create(bookService.create(Mono.just(new BookResource(UUID.randomUUID(),
            "123456789", "title", "description", Collections.singletonList("author"),
            false, null)
    ))).verifyError(AccessDeniedException.class);
  }

  ...

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As this is a JUnit 5 based integration test we use <em>@SpringJUnitConfig</em> to add spring JUnit 5 extension and configure the application context</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>All data access (the repositories) is mocked</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Positive test case of access control for creating books with role 'CURATOR'</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Negative test case of access control for creating books with roles 'USER' or 'ADMIN'</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Negative test case of access control for creating books with anonymous user</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For sure you have to add similar tests as well for the user part.</p>
</div>
<div class="listingblock">
<div class="title">UserServiceTest class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.library.server.business;

...

@DisplayName("Verify that user service")
@SpringJUnitConfig(LibraryServerApplication.class) <i class="conum" data-value="1"></i><b>(1)</b>
class UserServiceTest {

  @Autowired
  private UserService userService;

  @MockBean
  private UserRepository userRepository;

  @SuppressWarnings("unused")
  @MockBean
  private IdGenerator idGenerator;

  @DisplayName("grants access to find one user by email for anonymous user")
  @Test
  void verifyFindOneByEmailAccessIsGrantedForUnauthenticated() { <i class="conum" data-value="2"></i><b>(2)</b>
    when(userRepository.findOneByEmail(any())).thenReturn(Mono.just(new User(UUID.randomUUID(),
            "test@example.com", "secret", "Max", "Maier",
            Collections.singletonList(Role.USER))));
    StepVerifier.create(userService.findOneByEmail("test@example.com")).expectNextCount(1).verifyComplete();
  }

  @DisplayName("grants access to find one user by email for roles 'USER', 'CURATOR' and 'ADMIN'")
  @Test
  @WithMockUser(roles = {"USER", "CURATOR", "ADMIN"})
  void verifyFindOneByEmailAccessIsGrantedForAllRoles() { <i class="conum" data-value="3"></i><b>(3)</b>
    when(userRepository.findOneByEmail(any())).thenReturn(Mono.just(new User(UUID.randomUUID(),
            "test@example.com", "secret", "Max", "Maier",
            Collections.singletonList(Role.USER))));
    StepVerifier.create(userService.findOneByEmail("test@example.com")).expectNextCount(1).verifyComplete();
  }

  @DisplayName("denies access to create a user for roles 'USER' and 'CURATOR'")
  @Test
  @WithMockUser(roles = {"USER", "CURATOR"})
  void verifyCreateAccessIsDeniedForUserAndCurator() { <i class="conum" data-value="4"></i><b>(4)</b>
    StepVerifier.create(userService.create(Mono.just(new UserResource(UUID.randomUUID(),
            "test@example.com", "secret", "Max", "Maier",
            Collections.singletonList(Role.USER))))).verifyError(AccessDeniedException.class);
  }
  ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As this is a JUnit 5 based integration test we use <em>@SpringJUnitConfig</em> to add spring JUnit 5 extension and configure the application context</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Positive test case of access control for finding a user by email for anonymous user</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Positive test case of access control for finding a user by email with all possible roles</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Negative test case of access control for creating user with roles 'USER' or 'CURATOR'</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The testing part is the last part of adding security to the reactive style of the <em>library-server</em>
project.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You find the completed code in project <em>04-library-server</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the last workshop part we will look at the new OAuth2 login client and resource server introduced in Spring Security 5.0 and 5.1.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_5_oauth2_openid_connect"><a class="anchor" href="#_step_5_oauth2_openid_connect"></a><a class="link" href="#_step_5_oauth2_openid_connect">5.5. Step 5: OAuth2/OpenID Connect</a></h3>
<div class="sect3">
<h4 id="_introduction_2"><a class="anchor" href="#_introduction_2"></a><a class="link" href="#_introduction_2">5.5.1. Introduction</a></h4>
<div class="paragraph">
<p>OAuth2 is the base protocol for authorizing 3rd party authentication services
for using business services in the internet like stackoverflow.com.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oauth_roles.png" alt="oauth_roles">
</div>
</div>
<div class="paragraph">
<p>Authorizations are permitted via scopes that the user has to confirm before
using the requested service.</p>
</div>
<div class="paragraph">
<p>Depending on the application type OAuth2 provides the following grants (flows):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authorization Code Grant</p>
</li>
<li>
<p>Implicit Grant</p>
</li>
<li>
<p>Client Credentials Grant</p>
</li>
<li>
<p>Resource Owner Password Credentials Grant</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OpenID Connect (OIDC) is buiuld upon OAuth2 and provides additional identity information
to the scopes of OAuth2. For common enterprise applications OpenID Connect should be used.
Nowadays OAuth2 is frequently used together with providing identity in JSON web tokens (JWT).
But only OIDC specifies the use of JWT, OAuth2 does not.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/openid_roles.png" alt="openid_roles">
</div>
</div>
<div class="paragraph">
<p>OIDC adds an additional id token to the access token of OAuth2 and specifies
a user info endpoint to retrieve further user information.
With hybrid flow OIDC also adds one more grant (flow) to the existing ones of OAuth2.</p>
</div>
</div>
<div class="sect3">
<h4 id="_oauth2_oidc_in_spring_security_5"><a class="anchor" href="#_oauth2_oidc_in_spring_security_5"></a><a class="link" href="#_oauth2_oidc_in_spring_security_5">5.5.2. OAuth2/OIDC in Spring Security 5</a></h4>
<div class="paragraph">
<div class="title">Spring Security 5.0 introduced new support for OAuth2/OpenID Connect (OIDC) directly in spring security.</div>
<p>In short Spring Security 5.0 adds a completely rewritten implementation for OAuth2/OIDC which now is largely based
on a third party library <a href="https://connect2id.com/products/nimbus-oauth-openid-connect-sdk">Nimbus OAuth 2.0 SDK</a> instead of implementing all these functionality directly in Spring itself.</p>
</div>
<div class="paragraph">
<p>Spring Security 5.0 only provides the client side for servlet-based clients.</p>
</div>
<div class="paragraph">
<p>Spring Security 5.1 adds the resource server support and reactive support
for reactive clients and resource server as well.</p>
</div>
<div class="paragraph">
<p>Spring Security 5.2 will add a basic OAuth2/OIDC authorization server again (for local dev
and demos but not for productive use).</p>
</div>
<div class="paragraph">
<p>Before Spring Security 5.0 and Spring Boot 2.0 to implement OAuth2 you needed the separate project module
<a href="https://projects.spring.io/spring-security-oauth">Spring Security OAuth2</a>.</p>
</div>
<div class="paragraph">
<p>Now things have changed much, so it heavily depends now on the combination of Spring Security and Spring Boot versions
that are used how to implement OAuth2/OIDC.</p>
</div>
<div class="paragraph">
<p>Therefore you have to be aware of different approaches for Spring Security 4.x/Spring Boot 1.5.x
and Spring Security 5.x/Spring Boot 2.x.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. OAuth2 support in Spring Security + Spring Boot</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Security</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Boot</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authorization server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reactive (WebFlux)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.5.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>1</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>1</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>1</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>2</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(X)<sup>3</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(X)<sup>3</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.1.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>2</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>4</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(X)<sup>3</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>5</sup></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>2</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>4</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>6</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X<sup>5</sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><sup>1</sup> Spring Boot auto-config and separate <a href="https://projects.spring.io/spring-security-oauth">Spring Security OAuth project</a><br>
<sup>2</sup> New rewritten OAuth2 login client included in Spring Security 5.0<br>
<sup>3</sup> No direct support in Spring Security 5.0/Spring Boot 2.0. For auto-configuration with Spring Boot 2.0
you still have to use the separate <a href="https://projects.spring.io/spring-security-oauth">Spring Security OAuth project</a>
together with <a href="https://github.com/spring-projects/spring-security-oauth2-boot">Spring Security OAuth2 Boot compatibilty project</a><br>
<sup>4</sup> New refactored support for resource server as part of Spring Security 5.1<br>
<sup>5</sup> OAuth2 login client and resource server with reactive support as part of Spring Security 5.1.<br>
<sup>6</sup> New OAuth2 authorization server is planned as part of Spring Security 5.2</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The OAuth2/OpenID Connect Authorization Server provided by Spring Security 5.2 will mainly suit for fast prototyping and demo
purposes. For production please use one of the <a href="https://openid.net/developers/certified/">officially certified</a> products like for example
<a href="https://www.keycloak.org/">KeyCloak</a>, <a href="https://github.com/cloudfoundry/uaa">UAA</a> or <a href="https://www.okta.com/products/single-sign-on/">Okta</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can find more information on building OAuth2 secured microservices with Spring Boot <strong>1.5.x</strong> in</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-boot/docs/1.5.x/reference/htmlsingle/#boot-features-security-oauth2">Spring Boot 1.5 Reference Documentation</a></p>
</li>
<li>
<p><a href="https://projects.spring.io/spring-security-oauth/docs/oauth2.html">Spring Security OAuth2 Developers Guide</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can find more information on building OAuth2 secured microservices with Spring Boot <strong>2.1</strong>
and Spring Security <strong>5.1</strong> in</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-security-oauth2">Spring Boot 2.1 Reference Documentation</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#webflux-oauth2-login">Spring Security OAuth2/OIDC Login Client Reference Documentation</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#webflux-oauth2-resource-server">Spring Security OAuth2/OIDC Resource Server Reference Documentation</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security-oauth2-boot/docs/current/reference/htmlsingle">Spring Security OAuth Boot 2 Auto-config Documentation</a></p>
</li>
<li>
<p><a href="https://projects.spring.io/spring-security-oauth/docs/oauth2.html">Spring Security OAuth2 Developers Guide</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this workshop we will now look at what Spring Security 5.1 provides as new
OAuth2/OIDC Login Client and Resource Server - In a reactive way.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_we_will_build"><a class="anchor" href="#_what_we_will_build"></a><a class="link" href="#_what_we_will_build">5.5.3. What we will build</a></h4>
<div class="paragraph">
<p>In the <em>05-oauth2</em> project you will be provided the following sub-projects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>uaa</strong>: This is the OAuth2/OIDC identity management service of CloudFoundry which holds all users with their credentials.</p>
</li>
<li>
<p><strong>initial-library-server</strong>: The reactive version of the library server (similar to previous workshop step <em>04-library-server</em>)</p>
</li>
<li>
<p><strong>initial-oauth2-login-client</strong>: Initial code for this workshop part to implement the new OAuth2 Login Client</p>
</li>
<li>
<p><strong>oauth2-login-client</strong>: Complete code of the new OAuth2 Login Client (for reference)</p>
</li>
<li>
<p><strong>oauth2-library-server</strong>: Complete code of the reactive library OAuth2 resource server</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The spring implementation of the authorization server previously used (based on Spring Boot 1.5.x) is not
fully compliant with OIDC and therefore not usable any more with OAuth2/OIDC implementation
of Spring Security 5.1.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oauth2_spring_roles.png" alt="OAuth2 roles">
</div>
</div>
<div class="paragraph">
<p>These microservices have to be configured to be reachable via the following URL addresses (Port 8080 is the default port in spring boot).</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Microservice URL Adresses</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microservice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identity Management Server (UAA)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8090/uaa" class="bare">http://localhost:8090/uaa</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Library Client (OAuth2 Login Client)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8081" class="bare">http://localhost:8081</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Library-Server (OAuth2 Resource Server)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8080" class="bare">http://localhost:8080</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>So now let&#8217;s start.
Again, you will just use the provided <em>uaa</em> identity management server, the <em>initial-library-server</em>
and the <em>initial-oauth2-login-client</em> as starting point and implement
a OAuth2 resource server and login client based on the project.</p>
</div>
<div class="paragraph">
<p>But first read important information about how to start the required <em>uaa</em> identity management server.</p>
</div>
</div>
<div class="sect3">
<h4 id="identity-server"><a class="anchor" href="#identity-server"></a><a class="link" href="#identity-server">5.5.4. UAA Identity Server</a></h4>
<div class="paragraph">
<p>For this workshop the OpenID Connect certified <a href="https://github.com/cloudfoundry/uaa">UAA identity server</a> is provided.
UAA is an abbreviation for CloudFoundry User Account and Authentication.
This server is issuing OAuth2/OIDC JSON web tokens.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You may look into <a href="https://openid.net/certification/">OpenID Connect certified products</a>
to find a suitable identity management server for your project.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To start the UAA component you need an installed <a href="https://tomcat.apache.org/">Apache Tomcat</a> server.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Please <a href="https://tomcat.apache.org/download-80.cgi">download</a> most current version of the Apache Tomcat 8.x line and
extract the downloaded archive in a directory of your choice.</p>
</li>
<li>
<p>Open the file <em>05-oauth2/uaa/build.gradle</em> and replace the path entry for <em>tomcatHomeDir</em> with the
directory you have extracted the Apache Tomcat files into.</p>
</li>
<li>
<p>Execute <code><code>./gradlew downloadUAA</code></code> to download required war file for UAA</p>
</li>
<li>
<p>Execute <code><code>./gradlew cargoRunLocal</code></code> to start the UAA server</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Wait until the UAA server has been started.
If you see the output <code><code>Press Ctrl-C to stop the container</code></code> then UAA is ready.
You can also look into the file <em>05-oauth2/uaa/uaa-server.log</em> to see
the corresponding log output for UAA.</p>
</div>
<div class="paragraph">
<p>To see the configuration please open the following url in your web browser:
(Every OpenID Connect compliant identity server must provide a page at the endpoint <em>/&#8230;&#8203;/.well-known/openid-configuration</em></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8090/uaa/oauth/token/.well-known/openid-configuration" class="bare">http://localhost:8090/uaa/oauth/token/.well-known/openid-configuration</a></p>
</div>
<div class="paragraph">
<p>The important information provided by this is:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. Identity Server Configuration</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">issuer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Issuer url for issued tokens by this identity server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8090/uaa/oauth/token" class="bare">http://localhost:8090/uaa/oauth/token</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">authorization_endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handles authorization, usually asking for credentials and returns an authorization code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8090/uaa/oauth/authorize" class="bare">http://localhost:8090/uaa/oauth/authorize</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">token_endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Token endpoint (exchanges given authorization code for access token)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8090/uaa/oauth/token" class="bare">http://localhost:8090/uaa/oauth/token</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">userinfo_endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endpoint for requesting further user information</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8090/uaa/userinfo" class="bare">http://localhost:8090/uaa/userinfo</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jwks_uri</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uri for loading public keys to verify signatures of JSON web tokens</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8090/uaa/token_keys" class="bare">http://localhost:8090/uaa/token_keys</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="resource-server"><a class="anchor" href="#resource-server"></a><a class="link" href="#resource-server">5.5.5. Resource Server (Library-Server)</a></h4>
<div class="paragraph">
<p>For this workshop part the well-known library-server application is used and will be extended to act
 as a OAuth2 resource server.</p>
</div>
<div class="sect4">
<h5 id="client-gradle-dependencies"><a class="anchor" href="#client-gradle-dependencies"></a><a class="link" href="#client-gradle-dependencies">Gradle dependencies</a></h5>
<div class="paragraph">
<p>To use the new OAuth2 resource server support of Spring Security 5.1 you have to add the
following required dependencies to the existing gradle build file.</p>
</div>
<div class="listingblock">
<div class="title">gradle.build file</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>dependencies {
    ...
    compile('org.springframework.security:spring-security-oauth2-resource-server') <i class="conum" data-value="1"></i><b>(1)</b>
	compile('org.springframework.security:spring-security-oauth2-jose') <i class="conum" data-value="2"></i><b>(2)</b>
	...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This contains all code to build an OAuth 2.0/OIDC resource server</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This contains Spring Security’s support for the JOSE (Javascript Object Signing and Encryption) framework. This is needed
to support for example JSON Web Token (JWT)</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These dependencies already have been added to the initial project.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You may look into the spring security oauth2 boot reference documentation
<a href="https://docs.spring.io/spring-boot/docs/2.1.0.RC1/reference/htmlsingle/#boot-features-security-oauth2-server">Spring Boot 2.1 Reference Documentation</a>
and the <a href="https://docs.spring.io/spring-security/site/docs/5.1.1.RELEASE/reference/html5/#webflux-oauth2-resource-server">Spring Security 5.1.1 Reference Documentation</a> on how to implement a resource server.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_implementation_steps"><a class="anchor" href="#_implementation_steps"></a><a class="link" href="#_implementation_steps">Implementation steps</a></h5>
<div class="paragraph">
<p>First step is to configure an OAuth2 resource server. For this you have to register the corresponding
identity server/authorization server to use.</p>
</div>
<div class="listingblock">
<div class="title">application.yml file</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8090/uaa/oauth/token <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The issuer url is used to look up the well known configuration page to get all required configuration settings to set up a resource server</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">WebSecurityConfiguration.java file</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>@EnableWebFluxSecurity
@EnableReactiveMethodSecurity
public class WebSecurityConfiguration {

    @Bean
    public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
        http
                .csrf().disable()
                .authorizeExchange()
                .matchers(PathRequest.toStaticResources().atCommonLocations()).permitAll()
                .matchers(EndpointRequest.to("health")).permitAll()
                .matchers(EndpointRequest.to("info")).permitAll()
                .matchers(EndpointRequest.toAnyEndpoint()).hasAuthority("SCOPE_admin") <i class="conum" data-value="1"></i><b>(1)</b>
                .pathMatchers(HttpMethod.POST, "/books").hasAuthority("SCOPE_curator")
                .pathMatchers(HttpMethod.DELETE, "/books").hasAuthority("SCOPE_curator")
                .pathMatchers("/users/**").hasAuthority("SCOPE_admin")
                .pathMatchers("/books/**").hasAuthority("SCOPE_user")
                .anyExchange().authenticated()
                .and()
                .oauth2ResourceServer() <i class="conum" data-value="2"></i><b>(2)</b>
                .jwt(); <i class="conum" data-value="3"></i><b>(3)</b>
        return http.build();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>OAuth2 scopes are automatically mapped to <em>SCOPE_xxx</em> authorities (like the standard <em>ROLE_xxx</em> ones)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Autoconfiguration for an OAuth2 resource server</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configures JSON web token (JWT) handling for this resource server</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To start the resource server simply run the class <em>LibraryServerApplication</em> in
project <em>05-oauth2-client/initial-library-server</em>.</p>
</div>
<div class="paragraph">
<p>In the following paragraphs we now proceed to the workshop part where your interaction is required again:
The OAuth2 login client.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="oauth2-login-client"><a class="anchor" href="#oauth2-login-client"></a><a class="link" href="#oauth2-login-client">5.5.6. OAuth2 Login Client</a></h4>
<div class="sect4">
<h5 id="client-gradle-dependencies"><a class="anchor" href="#client-gradle-dependencies"></a><a class="link" href="#client-gradle-dependencies">Gradle dependencies</a></h5>
<div class="paragraph">
<p>To use the new OAuth2 client support of Spring Security 5.0 you have to add the
following required dependencies to the existing gradle build file.</p>
</div>
<div class="listingblock">
<div class="title">gradle.build file</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>dependencies {
    ...
	compile('org.springframework.security:spring-security-oauth2-client') <i class="conum" data-value="1"></i><b>(1)</b>
	compile('org.springframework.security:spring-security-oauth2-jose') <i class="conum" data-value="2"></i><b>(2)</b>
	...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This contains core classes and interfaces that provide support for the OAuth 2.0 Authorization Framework and for OpenID Connect Core 1.0</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This contains Spring Security’s support for the JOSE (Javascript Object Signing and Encryption) framework. This is needed
to support for example JSON Web Token (JWT)</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These dependencies already have been added to the initial project.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_implementation_steps_2"><a class="anchor" href="#_implementation_steps_2"></a><a class="link" href="#_implementation_steps_2">Implementation steps</a></h5>
<div class="paragraph">
<p>First step is to configure an OAuth2 login client. For this you have to register the corresponding
identity server/authorization server to use.
Here you have two possibilities:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You can just use one of the predefined ones (Facebook, Google, etc.)</p>
</li>
<li>
<p>You register your own custom server</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Spring security provides the enumeration <em>CommonOAuth2Provider</em> which defines registration details
for a lot of well known identity providers.</p>
</div>
<div class="listingblock">
<div class="title">CommonOAuth2Provider class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package org.springframework.security.config.oauth2.client;
...
public enum CommonOAuth2Provider {

	GOOGLE {

		@Override
		public Builder getBuilder(String registrationId) {
			ClientRegistration.Builder builder = getBuilder(registrationId,
					ClientAuthenticationMethod.BASIC, DEFAULT_LOGIN_REDIRECT_URL);
			builder.scope("openid", "profile", "email");
			builder.authorizationUri("https://accounts.google.com/o/oauth2/v2/auth");
			builder.tokenUri("https://www.googleapis.com/oauth2/v4/token");
			builder.jwkSetUri("https://www.googleapis.com/oauth2/v3/certs");
			builder.userInfoUri("https://www.googleapis.com/oauth2/v3/userinfo");
			builder.userNameAttributeName(IdTokenClaimNames.SUB);
			builder.clientName("Google");
			return builder;
		}
	},

	GITHUB {

		@Override
		public Builder getBuilder(String registrationId) {
            ...
		}
	},

	FACEBOOK {

		@Override
		public Builder getBuilder(String registrationId) {
		    ...
		}
	},
	...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use one of these providers is quite easy. Just reference the enumeration constant as the provider.</p>
</div>
<div class="listingblock">
<div class="title">Google provider properties class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>spring:
  security:
    oauth2:
      client:
        registration:
          google-login:	<i class="conum" data-value="1"></i><b>(1)</b>
            provider: google <i class="conum" data-value="2"></i><b>(2)</b>
            client-id: google-client-id
            client-secret: google-client-secret</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The registration id is set to <em>google-login</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The provider is set to the predefined <em>google</em> client which points to <em>CommonOAuth2Provider.GOOGLE</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But in this workshop we will focus on the second possibility and use our own local authorization server.<br>
To achieve this we add the following sections to the <em>application.yml</em> file.</p>
</div>
<div class="listingblock">
<div class="title">application.yml client configuration</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>spring:
  security:
    oauth2:
      client:
        registration:
          uaa:
            provider: uaa-authserver <i class="conum" data-value="1"></i><b>(1)</b>
            client-id: library <i class="conum" data-value="2"></i><b>(2)</b>
            client-secret: secret <i class="conum" data-value="3"></i><b>(3)</b>
            client-authentication-method: basic <i class="conum" data-value="4"></i><b>(4)</b>
            authorization-grant-type: authorization_code <i class="conum" data-value="5"></i><b>(5)</b>
            scopes: openid,profile,email,user,curator,admin <i class="conum" data-value="6"></i><b>(6)</b>
            client-name: UAA Client <i class="conum" data-value="7"></i><b>(7)</b>
            redirect-uri-template: "{baseUrl}/login/oauth2/code/{registrationId}" <i class="conum" data-value="8"></i><b>(8)</b>
        provider:
          uaa-authserver: <i class="conum" data-value="9"></i><b>(9)</b>
            authorization-uri: http://localhost:8090/uaa/oauth/authorize <i class="conum" data-value="10"></i><b>(10)</b>
            token-uri: http://localhost:8090/uaa/oauth/token <i class="conum" data-value="11"></i><b>(11)</b>
            user-info-uri: http://localhost:8090/uaa/userinfo <i class="conum" data-value="12"></i><b>(12)</b>
            user-name-attribute: sub <i class="conum" data-value="13"></i><b>(13)</b>
            jwk-set-uri: http://localhost:8090/uaa/token_keys <i class="conum" data-value="14"></i><b>(14)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>References the registered identity provider/authorization server to use for this OAuth2 client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The client id to use at the authorization server</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The client secret to use at the authorization server</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The authentication mode to use at the authorization server (may be basic or post)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The required OAuth2 flow, here the most commonly used flow <em>authorization_code</em> is used</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The required OAuth2 scope to use at the authorization server</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>A human readable name for this OAuth2 login client configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The pattern to build the required redirect URL back from authorization server to this client</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Name of the identity provider (in this case the local OAuth2 authorization server)</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The URI for authorizing the user at the authorization server (getting the authorization code)</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>The URI for getting a JWT token from the authorization server (exchanging the authorization code)</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>The URI to access the claims/attributes of the authenticated end-user using the JWT access token from the authorization server</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>The name of the attribute returned in the user info that references the name or identifier of the end-user. (retrieved from the user-info-uri endpoint)</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>URL pointing to the set of (rotating) public keys for verifying JWT signatures</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As the library-server is now configured as an OAuth2 resource server it requires
a valid JWT token to successfully call the <em>/books</em> endpoint now.</p>
</div>
<div class="paragraph">
<p>From client side we use the new <em>WebClient</em> for calls to the RESTful service.
WebClient is the successor of <em>RestTemplate</em> and works for both worlds (Servlet-based and reactive).</p>
</div>
<div class="paragraph">
<p>To support JWT tokens in calls we have to add a client interceptor to the <em>RestTemplate</em>.
The following code snippet shows how this is done:</p>
</div>
<div class="listingblock">
<div class="title">WebClientConfiguration class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.oauth2loginclient.config;

...
package com.example.oauth2loginclient.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.oauth2.client.registration.ReactiveClientRegistrationRepository;
import org.springframework.security.oauth2.client.web.reactive.function.client.ServerOAuth2AuthorizedClientExchangeFilterFunction;
import org.springframework.security.oauth2.client.web.server.ServerOAuth2AuthorizedClientRepository;
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
public class WebClientConfiguration {

    @Bean
    WebClient webClient(ReactiveClientRegistrationRepository clientRegistrationRepository,
                        ServerOAuth2AuthorizedClientRepository authorizedClientRepository) {
        ServerOAuth2AuthorizedClientExchangeFilterFunction oauth = <i class="conum" data-value="1"></i><b>(1)</b>
                new ServerOAuth2AuthorizedClientExchangeFilterFunction(clientRegistrationRepository, authorizedClientRepository);
        oauth.setDefaultOAuth2AuthorizedClient(true); <i class="conum" data-value="2"></i><b>(2)</b>
        return WebClient.builder()
                .filter(oauth) <i class="conum" data-value="3"></i><b>(3)</b>
                .build();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a filter for handling all the OAuth2 token stuff (i.e. initiating the OAuth2 grant flow)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Flag to automatically include the token handling into all webclient calls (use with caution)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the filter to webclient</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally we need an updated client side security configuration to allow
client endpoints and enable the OAuth2 client features:</p>
</div>
<div class="listingblock">
<div class="title">SecurityConfiguration class</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code>package com.example.oauth2loginclient.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;
import org.springframework.security.config.web.server.ServerHttpSecurity;
import org.springframework.security.core.userdetails.MapReactiveUserDetailsService;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.server.SecurityWebFilterChain;

@EnableWebFluxSecurity
@Configuration
public class SecurityConfiguration {

    @Bean
    SecurityWebFilterChain configure(ServerHttpSecurity http) throws Exception {
        http
                .authorizeExchange() <i class="conum" data-value="1"></i><b>(1)</b>
                .pathMatchers("/", "/books/**", "/users/**").permitAll() <i class="conum" data-value="2"></i><b>(2)</b>
                .anyExchange().authenticated()
                .and()
                .oauth2Login() <i class="conum" data-value="3"></i><b>(3)</b>
                .and()
                .formLogin()
                .and()
                .oauth2Client(); <i class="conum" data-value="4"></i><b>(4)</b>
        return http.build();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starting point for authorization rules (analogous to authorizeRequests in servlet world)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Allow all client side endpoints</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add OAuth2 login feature</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add OAuth2 standard client feature</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_run_all_the_components"><a class="anchor" href="#_run_all_the_components"></a><a class="link" href="#_run_all_the_components">Run all the components</a></h5>
<div class="paragraph">
<p>Finally start all three components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run <em>UAA</em> server in project <em>05-oauth2/uaa</em></p>
</li>
<li>
<p>Run <em>LibraryServerApplication</em> class in project <em>05-oauth2/initial-library-server</em></p>
</li>
<li>
<p>Run <em>OAuth2LoginClientApplication</em> class in project <em>05-oauth2/initial-oauth2-login-client</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now when you access <a href="http://localhost:8081/userinfo">localhost:8081/userinfo</a> you should be redirected to the UAA identity server.
After logging in you should get the current authenticated user info back from identity server.</p>
</div>
<div class="paragraph">
<p>Here you can log in using one of these predefined users:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. User credentials</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Roles</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:user@example.com">user@example.com</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USER</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:curator@example.com">curator@example.com</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">curator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USER, CURATOR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:admin@example.com">admin@example.com</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">admin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USER, CURATOR, ADMIN</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can now access <a href="http://localhost:8081/books">localhost:8081/books</a> as well.
This returns the book list from the library-server (resource server).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You find the completed code in project <em>05-oauth2/oauth2-login-client</em>
and <em>05-oauth2/oauth2-library-server</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This concludes our Spring Security 5.1 hands-on workshop.
I hope you learned a lot regarding security and especially Spring Security 5.1.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_feedback"><a class="anchor" href="#_feedback"></a><a class="link" href="#_feedback">6. Feedback</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Please provide feedback for this workshop directly to organization of the Frankfurter Entwicklertag
using the provided QR code.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/qr_code_frankfurter_entwicklertag.png" alt="novatec">
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have further feedback for this workshop, suggestions for improvements or you want me to
conduct this workshop somewhere else please do not hesitate to contact me via</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mail: <a href="mailto:andreas.falk@novatec-gmbh.de">andreas.falk@novatec-gmbh.de</a></p>
</li>
<li>
<p>Twitter: <a href="https://twitter.com/andifalk">@andifalk</a></p>
</li>
<li>
<p>LinkedIn: <a href="https://www.linkedin.com/in/andifalk">andifalk</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Thank YOU very much for being part of this workshop :-)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_online_references"><a class="anchor" href="#_online_references"></a><a class="link" href="#_online_references">Appendix A: Online References</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_Top_10">OWASP Top 10 2017</a></p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/OWASP_Proactive_Controls#tab=Main">OWASP ProActive Controls 2018</a></p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/OWASP_Testing_Project">OWASP Testing Guide</a></p>
</li>
<li>
<p><a href="https://oauth.net/2/">OAuth2 Specifications</a></p>
</li>
<li>
<p><a href="https://openid.net/specs/openid-connect-core-1_0.html">OpenID Connect 1.0 Specification</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-boot/docs/1.5.x/reference/htmlsingle/">Spring Boot 1.5 Reference Guide</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-boot/docs/2.1.0.RC1/reference/htmlsingle/">Spring Boot 2.1 Reference Guide</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security/site/docs/4.2.x/reference/htmlsingle/">Spring Security 4.x Reference Guide</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security/site/docs/5.1.1.RELEASE/reference/html5/">Spring Security 5.1.1 Reference Guide</a></p>
</li>
<li>
<p><a href="https://projects.spring.io/spring-security-oauth/docs/oauth2.html"><em>Legacy</em> Spring Security OAuth Reference Guide</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-security-oauth2-boot/docs/current/reference/htmlsingle/"><em>Legacy</em> Spring Security OAuth2 Boot Reference Guide</a></p>
</li>
<li>
<p><a href="https://github.com/andifalk/reactive-spring-security-5-workshop">Reactive Spring Security 5 Workshop Code</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_book_references"><a class="anchor" href="#_book_references"></a><a class="link" href="#_book_references">Appendix B: Book References</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://www.amazon.com/Iron-Clad-Java-Building-Secure-Applications/dp/0071835881/ref=sr_1_1?ie=UTF8&amp;qid=1526999159&amp;sr=8-1&amp;keywords=ironclad+java">Iron-Clad Java: Building Secure Web Applications (Oracle Press, ISBN: 978-0071835886)</a></p>
</li>
<li>
<p><a href="https://www.manning.com/books/oauth-2-in-action">OAuth 2 in Action (Manning Publications, ISBN: 978-1617293276)</a></p>
</li>
<li>
<p><a href="https://www.manning.com/books/spring-in-action-fifth-edition">Spring in Action 5th Edition (Manning Publications, ISBN: 978-1617294945</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-01-31 17:50:36 CET
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>